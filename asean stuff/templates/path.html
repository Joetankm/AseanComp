<!-- templates/map.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Map View</title>
  <style>
    body {
      background-image: url("{{ url_for('static', filename='backgroundimg.jpg') }}");
      background-size: cover;
      background-repeat: repeat-y;
      background-position: center;
    }

    input[type="text"],
    input[type="number"], 
    select {
      width: 100%;
      padding: 8px;
      margin-top: 4px;
      box-sizing: border-box;
      font-size: 16px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }

    .container {
      font-family: Arial, sans-serif;
      max-width: 70%;
      margin: 50px auto;
      padding: 20px;
      text-align: center;
      background-color: #f7f7f7;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }

    header{
        position: sticky;
        top: 0;
        z-index: 1000;  
        background-color: #B8E3E9; 
        padding: 15px; 
        display: flex; 
        justify-content: space-between; 
        align-items: center; 
        border: 10px solid #4F7C82; 
        border-radius: 10px;
        height: 80px
    }

    .map-wrapper {
        position: relative;
        width: 100%;
        margin: 0 auto;
        }

    .map-wrapper img {
        width: 100%;
        height: auto;
        display: block;
        border: 2px solid #333;
        border-radius: 10px;
        }

    .overlay {
      position: absolute;
      background-color: #4CC9F0;
      width: 3%;
      aspect-ratio: 1;
      border: 2px solid #1AA7EC;
      border-radius: 50%;
      cursor: pointer;
      transform: translate(-50%, -50%);
    }

    @media (max-width: 600px) {
      .container {
        max-width: 90%; /* make container stretch wider */
        padding: 10px;
      }

      img{
        height: auto;
        width: 100%;
      }

      h1 {
        font-size: 40px;
      }
      label {
        font-size: 20px;
      }
      button {
        font-size: 20px;
      }
      header{
        height: 100px;
      }
    }

    h1 {
      text-align: center;
      color: #333;
    }

    label {
      display: block;
      margin: 10px 0;
      text-align: left;
    }

    button {
      padding: 10px 20px;
      background-color: #007bff;
      color: white;
      border: none;
      margin-top: 10px;
      cursor: pointer;
      border-radius: 5px;
    }

    button:hover {
      background-color: #0056b3;
    }
  </style>
</head>
<body>
  <header>
    <h2 style="margin: 0;">Flood Risk Predictor</h2>
    <div>
      <button onclick="location.href='/'" style="margin-right: 10px;">Predict Page</button>
      <button onclick="location.href='/path'">Map View</button>
    </div>
  </header>

  <div class="container">
    <h1>Map View</h1>
    <p id="info" style="text-align:center;">Click a state to see details.</p>

    <!-- Responsive image + overlay wrapper -->
    <div class="map-wrapper">
      <img src="{{ url_for('static', filename='map.png') }}" alt="Map">

      <!-- Overlays -->
      <div class="overlay" onclick="fillForm('Pahang')" style="top: 50.78%; left: 18.40%;"></div>

      <div class="overlay" onclick="fillForm('Johor')" style="top: 75.08%; left: 23.15%;"></div>

      <div class="overlay" onclick="fillForm('Melaka')" style="top: 74.14%; left: 16.72%;"></div>

      <div class="overlay" onclick="fillForm('Negeri Sembilan')" style="top: 66.04%; left: 16.60%;"></div>

      <div class="overlay" onclick="fillForm('Selangor')" style="top: 57.94%; left: 11.83%;"></div>

      <div class="overlay" onclick="fillForm('Perak')" style="top: 35.51%; left: 8.88%;"></div>

      <div class="overlay" onclick="fillForm('Kedah')" style="top: 16.82%; left: 6.43%;"></div>

      <div class="overlay" onclick="fillForm('Kelantan')" style="top: 27.10%; left: 15.57%;"></div>

      <div class="overlay" onclick="fillForm('Penang')" style="top: 27.10%; left: 4.37%;"></div>

      <div class="overlay" onclick="fillForm('Terrenganu')" style="top: 33.64%; left: 21.61%;"></div>

      <div class="overlay" onclick="fillForm('Sarawak')" style="top: 74.14%; left: 63.59%;"></div>

      <div class="overlay" onclick="fillForm('Sabah')" style="top: 32.40%; left: 85.96%;"></div>
    </div>

    <h2 id="regionTitle"></h2>
    <p>Select a state above and change values accordingly or submit for prediction. <br>Save before predicting.</p>
    <form id="pathForm">
      <label>Flood Severity:
        <select name="Flood" required>
          <option value="">-- Select Severity --</option>
          <option value="1">1 - Very Low</option>
          <option value="2">2 - Low</option>
          <option value="3">3 - Mild</option>
          <option value="4">4 - Moderate</option>
          <option value="5">5 - Elevated</option>
          <option value="6">6 - High</option>
          <option value="7">7 - Very High</option>
          <option value="8">8 - Severe</option>
          <option value="9">9 - Critical</option>
          <option value="10">10 - Catastrophic</option>
        </select>
      </label>

      <label>Area Type:
        <select name="AreaType" required>
          <option value="">-- Select Area Type --</option>
          <option value="Urban">Urban</option>
          <option value="Rural">Rural</option>
        </select>
      </label>

      <label>Population: <input type="number" step="0.01" name="Population" required></label>

      <label>Medical Resources:
        <select name="Medical" required>
          <option value="">-- Select Availability --</option>
          <option value="Available">Available</option>
          <option value="Unavailable">Unavailable</option>
        </select>
      </label>

      <p id="infoDisplay" style="font-size: large; color: red; text-align: left;"></p>

      <button type="submit">Save</button>
      <button type="button" id="submitBtn">Submit for Prediction</button>
    </form>

    <script>
      const savedData = {};
      const regionList = [
        'Johor', 'Pahang', 'Melaka', 'Negeri Sembilan', 'Selangor',
        'Perak', 'Kedah', 'Kelantan', 'Penang', 'Terrenganu',
        'Sarawak', 'Sabah'
      ];

      const defaultValues = {
        "Johor": [5, "Urban", 4100000, "Available"],
        "Pahang": [6, "Rural", 1600000, "Unavailable"],
        "Melaka": [3, "Urban", 1000000, "Available"],
        "Negeri Sembilan": [4, "Urban", 1150000, "Available"],
        "Selangor": [7, "Urban", 6500000, "Available"],
        "Perak": [5, "Urban", 2500000, "Available"],
        "Kedah": [4, "Rural", 2200000, "Unavailable"],
        "Kelantan": [6, "Rural", 1900000, "Unavailable"],
        "Penang": [4, "Urban", 1800000, "Available"],
        "Terrenganu": [5, "Rural", 1300000, "Unavailable"],
        "Sarawak": [7, "Rural", 2800000, "Unavailable"],
        "Sabah": [6, "Rural", 3500000, "Unavailable"]
      };

      function initializeDefaultRegions() {
        regionList.forEach(region => {
          const [flood, areaType, population, medical] = defaultValues[region];
          savedData[region] = {
            Flood: flood,
            AreaType: areaType,
            Population: population,
            Medical: medical
          };
        });
      }

      function fillForm(area) {
        const form = document.getElementById('pathForm');
        const regionTitle = document.getElementById('regionTitle');
        form.setAttribute('data-region', area);
        regionTitle.textContent = `Selected State: ${area}`;

        if (savedData[area]) {
          form.Flood.value = savedData[area].Flood;
          form.AreaType.value = savedData[area].AreaType;
          form.Population.value = savedData[area].Population;
          form.Medical.value = savedData[area].Medical;
        }
      }

      async function submitPrediction(e) {
  e.preventDefault();

  const regions = Object.entries(savedData).map(([name, data]) => ({
    Area: name,
    Flood: data.Flood,
    AreaType: data.AreaType,
    Population: data.Population,
    Medical: data.Medical
  }));

  try {
    const response = await fetch("/submit", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ regions })
    });

    const result = await response.json();
    const est = result.Estimates;


    const infoDisplay = document.getElementById("infoDisplay");
    infoDisplay.innerHTML = `
      <strong>${result.Area.toUpperCase()}</strong> is the CRITICAL ZONE!<br>
      Danger Score: ${result.Priority.toFixed(2)}%<br>
      Location Type: ${result.AreaType}<br>
      Flood Severity: ${result.Flood}/10<br>
      Population: ${result.Population} people<br>
      Medical Resources: ${result.Medical === "Available" ? "Present" : "None"}<br><br>
      <u>Estimated Resources Needed:</u><br>
        Food: ${est.Food} meals<br>
        Water: ${est.Water} litres<br>
        Shelter: ${est.Shelter} people<br>
        Medical Staff: ${est.MedicalStaff} personnel
    `;
  } catch (error) {
    alert("Error submitting prediction: " + error.message);
  }
}



      document.addEventListener('DOMContentLoaded', () => {
        initializeDefaultRegions();

        const form = document.getElementById('pathForm');
        form.addEventListener('submit', function (e) {
          e.preventDefault();
          const region = form.getAttribute('data-region');
          if (!region) {
            alert("Please select a region first.");
            return;
          }

          savedData[region] = {
            Flood: form.Flood.value,
            AreaType: form.AreaType.value,
            Population: form.Population.value,
            Medical: form.Medical.value
          };
          alert(`Data for ${region} saved!`);
        });

        document.getElementById("submitBtn").addEventListener("click", submitPrediction);
      });
    </script>
  </div>
</body>
</html>
