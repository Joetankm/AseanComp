<!-- templates/map.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Map View</title>
  <style>
    body {
      background-image: url("{{ url_for('static', filename='backgroundimg.jpg') }}");
      background-size: cover;
      background-repeat: repeat-y;
      background-position: center;
    }

    input[type="text"],
    input[type="number"], 
    select {
      width: 100%;
      padding: 8px;
      margin-top: 4px;
      box-sizing: border-box;
      font-size: 16px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }

    .container {
      font-family: Arial, sans-serif;
      max-width: 70%;
      margin: 50px auto;
      padding: 20px;
      text-align: center;
      background-color: #f7f7f7;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }

    header{
        position: sticky;
        top: 0;
        z-index: 1000;  
        background-color: #94DEA5; 
        padding: 15px; 
        display: flex; 
        justify-content: space-between; 
        align-items: center; 
        color: #003333;
        border: 10px solid #006600; 
        border-radius: 10px;
        height: 80px
    }
    header button{
      background-color: #2c8769;
      color: #bddbe8;
    }
    header button:hover{
      background-color: #006600;
    }

    .map-wrapper {
        position: relative;
        width: 100%;
        margin: 0 auto;
        }

    .map-wrapper img {
        width: 100%;
        height: auto;
        display: block;
        border: 2px solid #333;
        border-radius: 10px;
        }

    .overlay {
      transition: all 0.3s ease;
      position: absolute;
      background-color: #4CC9F0;
      width: 3%;
      aspect-ratio: 1;
      border: 2px solid #1AA7EC;
      border-radius: 50%;
      cursor: pointer;
      transform: translate(-50%, -50%);
    }

    @media (max-width: 600px) {
      .container {
        max-width: 90%; /* make container stretch wider */
        padding: 10px;
      }

      img{
        height: auto;
        width: 100%;
      }

      h1 {
        font-size: 40px;
      }
      label {
        font-size: 20px;
      }
      button {
        font-size: 20px;
        width: 100%;
      }
      header{
        height: 100px;
        display: flex; 
        flex-direction: column; 
        align-items: flex-start;
      }
      .headerBtn{
        display: flex; 
        flex-direction: row; 
        margin: auto;
      }
    }

    h1 {
      text-align: center;
      color: #333;
    }

    label {
      display: block;
      margin: 10px 0;
      text-align: left;
    }

    button {
      padding: 10px 20px;
      background-color: #007bff;
      color: white;
      border: none;
      margin-top: 10px;
      cursor: pointer;
      border-radius: 5px;
    }

    button:hover {
      background-color: #0056b3;
    }
  </style>
</head>
<body>
  <header>
    <h2 style="margin: 0; font-family: Arial, Helvetica, sans-serif;">PredictSungAI</h2>
    <div class="headerBtn">
      <button onclick="location.href='/'" style="margin-right: 10px;">Predict Page</button>
      <button onclick="location.href='/path'">Map View</button>
    </div>
  </header>

  <div class="container">
    <h1>Map View</h1>
    <p id="info" style="text-align:center;">Click a state to see details.</p>

    <!-- Responsive image + overlay wrapper -->
    <div class="map-wrapper">
      <img src="{{ url_for('static', filename='map.png') }}" alt="Map">

      <!-- Overlays -->
      <div class="overlay" onclick="doTwoThings(this,'Pahang')" style="top: 50.78%; left: 18.40%;"></div>

      <div class="overlay" onclick="doTwoThings(this,'Perlis')" style="top: 8.72%; left: 3.73%;"></div>

      <div class="overlay" onclick="doTwoThings(this,'Johor')" style="top: 75.08%; left: 23.15%;"></div>

      <div class="overlay" onclick="doTwoThings(this,'Melaka')" style="top: 74.14%; left: 16.72%;"></div>

      <div class="overlay" onclick="doTwoThings(this,'Negeri Sembilan')" style="top: 66.04%; left: 16.60%;"></div>

      <div class="overlay" onclick="doTwoThings(this,'Selangor')" style="top: 57.94%; left: 11.83%;"></div>

      <div class="overlay" onclick="doTwoThings(this,'Perak')" style="top: 35.51%; left: 8.88%;"></div>

      <div class="overlay" onclick="doTwoThings(this,'Kedah')" style="top: 16.82%; left: 6.43%;"></div>

      <div class="overlay" onclick="doTwoThings(this,'Kelantan')" style="top: 27.10%; left: 15.57%;"></div>

      <div class="overlay" onclick="doTwoThings(this,'Penang')" style="top: 27.10%; left: 4.37%;"></div>

      <div class="overlay" onclick="doTwoThings(this,'Terengganu')" style="top: 33.64%; left: 21.61%;"></div>

      <div class="overlay" onclick="doTwoThings(this,'Sarawak')" style="top: 74.14%; left: 63.59%;"></div>

      <div class="overlay" onclick="doTwoThings(this,'Sabah')" style="top: 32.40%; left: 85.96%;"></div>
    </div>

    <h2 id="regionTitle"></h2>
    <p>Select a state above and change values accordingly or submit for prediction. <br>Save before predicting.</p>
    <form id="pathForm">
      <label>Flood Severity:
        <select name="Flood" required>
          <option value="">-- Select Severity --</option>
          <option value="1">1 - Very Low</option>
          <option value="2">2 - Low</option>
          <option value="3">3 - Mild</option>
          <option value="4">4 - Moderate</option>
          <option value="5">5 - Elevated</option>
          <option value="6">6 - High</option>
          <option value="7">7 - Very High</option>
          <option value="8">8 - Severe</option>
          <option value="9">9 - Critical</option>
          <option value="10">10 - Catastrophic</option>
        </select>
      </label>

      <label>Area Type:
        <select name="AreaType" required>
          <option value="">-- Select Area Type --</option>
          <option value="Urban">Urban</option>
          <option value="Rural">Rural</option>
        </select>
      </label>

      <label>Population: <input type="number" step="0.01" name="Population" required></label>

      <label>Medical Resources:
        <select name="Medical" required>
          <option value="">-- Select Availability --</option>
          <option value="Available">Available</option>
          <option value="Unavailable">Unavailable</option>
        </select>
      </label>

      <div style="display: flex; flex-direction: row; gap: 20%; justify-content: center; ">
        <p id="infoDisplay1" style="font-size: large; color: red; text-align: left;"></p>
        <p id="infoDisplay2" style="font-size: large; color: red; text-align: left;"></p>
      </div>
      <span id = "infoDisplay3" style="font-size: 0.7em; color: #666; display: none;">*This value was calculated using an AI-driven random forest machine learning model.</span>
      <div style="display: flex; flex-direction: row; gap: 10%; justify-content: center; ">
        <p id="ucsDisplay1" style="font-size: large; text-align: left;"></p>
        <p id="ucsDisplay2" style="font-size: large; text-align: left;"></p>
      </div>
      <span id = "ucsDisplay3" style="font-size: 0.7em; color: #666; display: none;">*This path was generated using UCS, an AI-driven search algorithm focused on minimizing cost (distance).</span>
      <button type="submit">Save</button>
      <button type="button" id="submitBtn">Submit for Prediction</button>
      <button type="button" id="ucsPathBtn" style="display: none;">Predict Path</button>
    </form>

    <script>
      let criticalRegion = null;
      let selectedRegion = null;
      const savedData = {};
      const regionList = [
        'Johor', 'Pahang', 'Melaka', 'Negeri Sembilan', 'Selangor',
        'Perak', 'Kedah', 'Kelantan', 'Penang', 'Terengganu',
        'Sarawak', 'Sabah', 'Perlis'
      ];

      const defaultValues = {
        "Johor": [5, "Urban", 4100000, "Available"],
        "Pahang": [6, "Urban", 1600000, "Unavailable"],
        "Melaka": [3, "Urban", 1000000, "Available"],
        "Negeri Sembilan": [4, "Urban", 1150000, "Available"],
        "Selangor": [7, "Urban", 6500000, "Available"],
        "Perak": [5, "Urban", 2500000, "Available"],
        "Kedah": [7, "Rural", 2200000, "Unavailable"],
        "Kelantan": [6, "Rural", 1900000, "Unavailable"],
        "Penang": [4, "Urban", 1800000, "Available"],
        "Terengganu": [5, "Rural", 1300000, "Unavailable"],
        "Sarawak": [7, "Rural", 2800000, "Unavailable"],
        "Sabah": [6, "Rural", 3500000, "Unavailable"],
        "Perlis": [3, "Rural", 260000, "Unavailable"]
      };

      function initializeDefaultRegions() {
        regionList.forEach(region => {
          const [flood, areaType, population, medical] = defaultValues[region];
          savedData[region] = {
            Flood: flood,
            AreaType: areaType,
            Population: population,
            Medical: medical
          };
        });
      }

      function doTwoThings(overlay,area){
        selectedRegion = area;
        fillForm(area);
        changeShapeClr(overlay);
      }

      function changeShapeClr(clickedEl){
        document.querySelectorAll('.overlay').forEach(el => {
          el.style.backgroundColor = "";
          el.style.border = "";
          el.style.width = "";
          if (criticalRegion && el.getAttribute("onclick").includes(`'${criticalRegion.Area}'`)) {
            el.style.backgroundColor = "#cc0000";  // critical red
            el.style.border = "2px solid #660000";
            el.style.width = "4%";
          } 
          if (el === clickedEl){
            el.style.backgroundColor = "green";
            el.style.border = "2px solid #006400";
            el.style.width = "4%";
        } 
      }); 
      }

      function fillForm(area) {
        const form = document.getElementById('pathForm');
        const regionTitle = document.getElementById('regionTitle');
        form.setAttribute('data-region', area);
        regionTitle.textContent = `Selected State: ${area}`;

        if (savedData[area]) {
          form.Flood.value = savedData[area].Flood;
          form.AreaType.value = savedData[area].AreaType;
          form.Population.value = savedData[area].Population;
          form.Medical.value = savedData[area].Medical;
        }
      }

      async function submitPrediction(e) {
        e.preventDefault();
        const ucsPathBtn = document.getElementById("ucsPathBtn").style.display="inline";

        const regions = Object.entries(savedData).map(([name, data]) => ({
          Area: name,
          Flood: data.Flood,
          AreaType: data.AreaType,
          Population: data.Population,
          Medical: data.Medical
        }));

        try {
          const response = await fetch("/submit", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ regions })
          });

          criticalRegion = await response.json();
          const est = criticalRegion.Estimates;
          document.querySelectorAll('.overlay').forEach(el => {
          if (el.getAttribute("onclick").includes(`'${criticalRegion.Area}'`)) {
            el.style.backgroundColor = "#cc0000";  // critical red
            el.style.border = "2px solid #660000"; // darker border
            el.style.width= "4%";
          } else if (el.getAttribute("onclick").includes(`'${selectedRegion}'`)){
            el.style.border = "2px solid #006400"; // Darker red
            el.style.backgroundColor = "green";  // Red
            el.style.width= "4%";
          } else {
            el.style.backgroundColor = ""; // reset
            el.style.border = "";
            el.style.width = "";
          }
        });


          const infoDisplay1 = document.getElementById("infoDisplay1");
          const infoDisplay2 = document.getElementById("infoDisplay2");
          const infoDisplay3 = document.getElementById("infoDisplay3");
          infoDisplay3.style.display = "block";
          infoDisplay1.innerHTML = `
            <strong>${criticalRegion.Area.toUpperCase()}</strong> is the CRITICAL ZONE!<br>
            <strong>Danger Score: </strong>${criticalRegion.Priority.toFixed(2)}%<br>
            <strong>Location Type: </strong>${criticalRegion.AreaType}<br>
            <strong>Flood Severity: </strong>${criticalRegion.Flood}/10<br>
            <strong>Population: </strong>${criticalRegion.Population} people<br>
            <strong>Medical Resources: </strong>${criticalRegion.Medical === "Available" ? "Present" : "None"}
          `;
          infoDisplay2.innerHTML = `
            <strong><u>Estimated Resources Needed:</u></strong><br>
              <strong>Food: </strong>${est.Food} meals<br>
              <strong>Water: </strong>${est.Water} litres<br>
              <strong>Shelter: </strong>${est.Shelter} people<br>
              <strong>Medical Staff: </strong>${est.MedicalStaff} personnel
          `;
        } catch (error) {
          alert("Error submitting prediction: " + error.message);
        }
      }

        async function getUCSPath(start, goal) {
          try {
            const ucsDisplay1 = document.getElementById("ucsDisplay1");
            const ucsDisplay2 = document.getElementById("ucsDisplay2");
            const ucsDisplay3 = document.getElementById("ucsDisplay3");
            
            const response = await fetch("/ucsPath", {
              method: "POST",
              headers: {
                "Content-Type": "application/json"
              },
              body: JSON.stringify({ start, goal })
            });

            const result = await response.json();

            if (response.ok) {
              ucsDisplay3.style.display = "block";
              console.log("Path:", result.path);
              console.log("Cost:", result.cost);

              result.path.forEach(node => {
                document.querySelectorAll('.overlay').forEach(el => {
                  if (el.getAttribute("onclick").includes(`'${criticalRegion.Area}'`)){
                    el.style.backgroundColor = "#cc0000";  // critical red
                    el.style.border = "2px solid #660000"; // darker border
                    el.style.width= "4%";
                  } else if (el.getAttribute("onclick").includes(`'${selectedRegion}'`)){
                    el.style.border = "2px solid #006400"; // Darker red
                    el.style.backgroundColor = "green";  // Red
                    el.style.width= "4%";
                  } else if (el.getAttribute("onclick")?.includes(`'${node}'`)) {
                    el.style.border = "2px solid gray"; // Dark green border
                    el.style.backgroundColor = "darkgray";    // Green fill
                    el.style.width = "3%";
                  }
                });
              });

              ucsDisplay1.innerHTML = `
                Shortest path from 
                <br><strong style="color: green;">${result.path[0]}</strong> to <strong style = "color: red">${result.path.at(-1)}</strong>:
                <div style="text-align: center;">
                  <strong>${result.path.join("<br> ↓ <br>")}</strong>
                </div>
              `;
              ucsDisplay2.innerHTML = `
                Distance from 
                <br><strong style="color: green;">${result.path[0]}</strong> to <strong style = "color: red">${result.path.at(-1)}</strong>: 
                <br><strong>${result.cost.toFixed(2)}km</strong><br><br>
                Time taken if travelling at speed of:
                <br><strong>30 km/h:</strong> ${Math.floor(result.cost / 30)}h ${Math.round(((result.cost / 30) % 1) * 60)}m
                <br><strong>60 km/h:</strong> ${Math.floor(result.cost / 60)}h ${Math.round(((result.cost / 60) % 1) * 60)}m
                <br><strong>90 km/h:</strong> ${Math.floor(result.cost / 90)}h ${Math.round(((result.cost / 90) % 1) * 60)}m
          `;
              // Optional: display to user
            } else {
              console.error("Error:", result.error);
              alert(result.error);
            }
          } catch (error) {
            console.error("Fetch failed:", error);
          }
        }




      document.addEventListener('DOMContentLoaded', () => {
        initializeDefaultRegions();

        const form = document.getElementById('pathForm');
        form.addEventListener('submit', function (e) {
          e.preventDefault();
          const region = form.getAttribute('data-region');
          if (!region) {
            alert("Please select a region first.");
            return;
          }

          savedData[region] = {
            Flood: form.Flood.value,
            AreaType: form.AreaType.value,
            Population: form.Population.value,
            Medical: form.Medical.value
          };
          alert(`Data for ${region} saved!`);
        });

        document.getElementById("submitBtn").addEventListener("click", submitPrediction);
        document.getElementById("ucsPathBtn").addEventListener("click", () => {
          getUCSPath(selectedRegion, criticalRegion.Area);
        });
      });
    </script>
  </div>
</body>
</html>
